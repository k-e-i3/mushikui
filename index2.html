<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="robots" content="noindex">
    <title>ãƒ†ãƒ¬ãƒ—ãƒ­ãƒ³ãƒ—ã‚¿ãƒ¼å‹æš—è¨˜æ”¯æ´ã‚¢ãƒ—ãƒª (v18 - ä¿®æ­£ç‰ˆ)</title>
    <style>
        :root {
            --bg-color: #ededed;
            --text-color: #222222;
            --highlight-color: #FFF1AB;
            --guide-color: #335555;
            --panel-bg-color: #f0f0f0;
            --border-color: #ccc;
        }
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap');
        html {
            touch-action: none;
        }
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            -webkit-user-select: none; user-select: none;
        }
        .control-panel {
            background-color: var(--panel-bg-color);
            padding: 10px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex; flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
        }
        .controls-left, .controls-right {
            display: flex; align-items: center; flex-wrap: wrap; gap: 15px;
        }
        .control-group {
            display: flex; align-items: center; gap: 5px;
        }
        .control-group label {
            font-size: 14px; white-space: nowrap; cursor: pointer;
        }
        button, select {
            background-color: #ddd; color: var(--text-color); border: 1px solid var(--border-color);
            padding: 8px 12px; border-radius: 5px; cursor: pointer;
            font-family: inherit; font-size: 14px; transition: background-color 0.2s;
        }
        button:hover, select:hover { background-color: #e8e8e8; }
        #play-pause-btn { min-width: 80px; text-align: center; }
        input[type="range"] { cursor: pointer; }
        #info-panel { font-size: 12px; display: flex; gap: 15px; min-width: 220px; }
        #info-panel p { margin: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        #info-panel p:first-child { flex-shrink: 0; }
        #info-panel p:last-child { min-width: 0; }
        main { flex-grow: 1; position: relative; overflow: hidden; }
        #guide-line {
            position: absolute; top: 30%; left: 0; width: 100%; height: 2px;
            background-color: var(--guide-color); z-index: 10; pointer-events: none;
        }
        #text-container { width: 100%; height: 100%; overflow: hidden; cursor: grab; }
        #text-container:active { cursor: grabbing; }
        #text-content {
            padding: 50vh 20px; font-size: 24px; line-height: 1.8;
            transition: none; transform: translateY(0px); box-sizing: border-box;
        }
        .loading-message { text-align: center; padding-top: 20vh; opacity: 0.7; }
        .word { display: inline-block; }
        .char { display: inline-block; transition: color 0.3s, background-color 0.3s, border-bottom-color 0.3s; }
        .word.highlight { background-color: var(--highlight-color); color: var(--text-color); border-radius: 3px; padding: 0 0.2em; }
        .char.hidden { color: transparent; border-bottom: 1px solid var(--text-color); cursor: pointer; }
        .word.highlight .char.hidden { color: transparent; border-bottom-color: var(--text-color); }
        .char.revealed { color: var(--text-color); border-bottom-color: transparent !important; }
        .placeholder-dot { color: #8A9A5B; opacity: 0.7; }

        /* ãƒ†ã‚­ã‚¹ãƒˆç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #editor-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.6); z-index: 1000;
            justify-content: center; align-items: center;
        }
        .editor-content {
            background-color: #fff; padding: 20px; border-radius: 8px;
            width: 80%; max-width: 600px; display: flex;
            flex-direction: column; gap: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        #text-editor {
            width: 100%; height: 40vh; font-size: 16px;
            resize: vertical; border: 1px solid #ccc; padding: 10px; box-sizing: border-box;
        }
        .editor-buttons { display: flex; gap: 10px; justify-content: flex-end; }
    </style>
</head>
<body>
    <header class="control-panel">
        <div class="controls-left">
            <div class="control-group">
                <button id="play-pause-btn">å†ç”Ÿ</button>
                <button id="reset-btn">ãƒªã‚»ãƒƒãƒˆ</button>
            </div>
             <div class="control-group">
                <button id="edit-text-btn">ğŸ“ ãƒ†ã‚­ã‚¹ãƒˆç·¨é›†</button>
            </div>
            <div class="control-group">
                <label for="text-select">ãƒ†ã‚­ã‚¹ãƒˆé¸æŠ:</label>
                <select id="text-select"></select>
            </div>
            <div class="control-group">
                <input type="checkbox" id="speech-toggle">
                <label for="speech-toggle">èª­ã¿ä¸Šã’</label>
                <select id="voice-select" title="éŸ³å£°ã‚’é¸æŠ"></select>
            </div>
            <div class="control-group">
                <label for="font-size-slider">æ–‡å­—:<span id="font-size-value">24</span>px</label>
                <input type="range" id="font-size-slider" min="16" max="40" value="24" style="width: 80px;">
            </div>
            <div class="control-group">
                <label for="speed-slider">é€Ÿåº¦:<span id="speed-value">1.8</span>s</label>
                <input type="range" id="speed-slider" min="0.1" max="3" step="0.1" value="1.8" style="width: 80px;">
            </div>
            <div class="control-group">
                <label for="mask-rate-slider">è™«é£Ÿã„:<span id="mask-rate-value">55</span>%</label>
                <input type="range" id="mask-rate-slider" min="0" max="80" value="55" style="width: 80px;">
            </div>
        </div>
        <div class="controls-right">
            <div id="info-panel">
                <p>é€²æ—: <span id="progress-info">0</span>%</p>
                <p>ç¾åœ¨å˜èª: <span id="word-info">-</span></p>
            </div>
        </div>
    </header>
    <main>
        <div id="guide-line"></div>
        <div id="text-container">
            <div id="text-content">
                <p class="loading-message">ãƒ†ã‚­ã‚¹ãƒˆãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</p>
            </div>
        </div>
    </main>

    <div id="editor-modal">
        <div class="editor-content">
            <h3>ãƒ†ã‚­ã‚¹ãƒˆã‚’ç·¨é›†</h3>
            <textarea id="text-editor"></textarea>
            <div class="editor-buttons">
                <button id="cancel-edit-btn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button id="save-text-btn" style="background-color: #4CAF50; color: white;">é©ç”¨ã—ã¦é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>
    
    <script>
document.addEventListener('DOMContentLoaded', () => {
    class AnkiTeleprompter {
        constructor() {
            this.els = {
                speechToggle: document.getElementById('speech-toggle'),
                voiceSelect: document.getElementById('voice-select'),
                textSelect: document.getElementById('text-select'),
                textContent: document.getElementById('text-content'),
                textContainer: document.getElementById('text-container'),
                guideLine: document.getElementById('guide-line'),
                playPauseBtn: document.getElementById('play-pause-btn'),
                resetBtn: document.getElementById('reset-btn'),
                fontSizeSlider: document.getElementById('font-size-slider'),
                speedSlider: document.getElementById('speed-slider'),
                maskRateSlider: document.getElementById('mask-rate-slider'),
                fontSizeValue: document.getElementById('font-size-value'),
                speedValue: document.getElementById('speed-value'),
                maskRateValue: document.getElementById('mask-rate-value'),
                progressInfo: document.getElementById('progress-info'),
                wordInfo: document.getElementById('word-info'),
                // ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨ã®è¦ç´ ã‚’è¿½åŠ 
                editTextBtn: document.getElementById('edit-text-btn'),
                editorModal: document.getElementById('editor-modal'),
                textEditor: document.getElementById('text-editor'),
                saveTextBtn: document.getElementById('save-text-btn'),
                cancelEditBtn: document.getElementById('cancel-edit-btn'),
            };
            this.state = {
                isPlaying: false, currentWordIndex: -1, words: [], voices: [], timer: null,
                voiceLoadRetries: 0, textFiles: [],
                originalText: 'ä¸‹ã®ã€Œãƒ†ã‚­ã‚¹ãƒˆé¸æŠã€ã‹ã‚‰å­¦ç¿’ã—ãŸã„æ–‡ç« ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚',
                fontSize: 24, highlightSpeed: 1500, maskRate: 0.3,
            };
            this.dragState = { isDragging: false, isTap: true, startX: 0, startY: 0, startTranslateY: 0 };
            this.githubInfo = { username: 'k-e-i3', repo: 'mushikui' };

            this.loadSettings();
            this.init();
            this.initSpeech();
        }

        init() {
            this.bindEvents();
            this.updateUIFromState();
            this.loadTextList();
        }
        
        async loadTextList() {
            const url = `https://${this.githubInfo.username}.github.io/${this.githubInfo.repo}/index.json?t=${new Date().getTime()}`;
            try {
                const response = await fetch(url, { cache: 'no-store' });
                if (!response.ok) throw new Error('ç›®æ¬¡ãƒ•ã‚¡ã‚¤ãƒ«(index.json)ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
                
                const fileList = await response.json();
                this.state.textFiles = fileList;

                // ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã®å…ˆé ­ã«ã€Œã‚«ã‚¹ã‚¿ãƒ ãƒ†ã‚­ã‚¹ãƒˆã€ã‚’è¿½åŠ 
                this.els.textSelect.innerHTML = '<option value="" disabled>--- GitHubã‹ã‚‰é¸æŠ ---</option>';
                this.state.textFiles.forEach(fileName => {
                    const option = document.createElement('option');
                    option.value = fileName;
                    option.textContent = fileName.replace('.txt', '');
                    this.els.textSelect.appendChild(option);
                });

                if (this.state.textFiles.length > 0) {
                    this.els.textSelect.selectedIndex = 1; // æœ€åˆã®ãƒ†ã‚­ã‚¹ãƒˆã‚’é¸æŠ
                    this.loadTextContent(this.state.textFiles[0]);
                } else {
                    this.renderText();
                }
            } catch (error) {
                this.els.textContent.innerHTML = `<p class="loading-message">${error.message}<br>GitHubä¸Šã§index.jsonãŒæ­£ã—ãè¨­ç½®ã•ã‚Œã¦ã„ã‚‹ã‹ã”ç¢ºèªãã ã•ã„ã€‚</p>`;
            }
        }

        async loadTextContent(fileName) {
            if (!fileName) return;
            this.state.currentTextSource = fileName; // ã©ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠä¸­ã‹è¨˜éŒ²
            const url = `https://${this.githubInfo.username}.github.io/${this.githubInfo.repo}/${fileName}?t=${new Date().getTime()}`;
            this.els.textContent.innerHTML = `<p class="loading-message">èª­ã¿è¾¼ã¿ä¸­: ${fileName}</p>`;
            try {
                const response = await fetch(url, { cache: 'no-store' });
                if (!response.ok) throw new Error(`ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ${fileName}ï¼‰ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚`);
                const text = await response.text();
                this.state.originalText = text;
                this.renderText();
            } catch (error) {
                 this.els.textContent.innerHTML = `<p class="loading-message">${error.message}</p>`;
            }
        }
        
        initSpeech() {
            if ('speechSynthesis' in window) {
                const populate = () => this.populateVoiceList();
                speechSynthesis.onvoiceschanged = populate;
                this.populateVoiceList();
            } else {
                const speechControl = this.els.speechToggle.parentElement;
                if(speechControl) speechControl.style.display = 'none';
            }
        }
        
        populateVoiceList() {
            const voices = speechSynthesis.getVoices();
            if (voices.length === 0 && this.state.voiceLoadRetries < 15) {
                this.state.voiceLoadRetries++;
                setTimeout(() => this.populateVoiceList(), 200);
                return;
            }
            this.state.voices = voices.filter(voice => voice.lang === 'ja-JP');
            this.els.voiceSelect.innerHTML = '';
            if (this.state.voices.length > 0) {
                this.state.voices.forEach(voice => {
                    const option = document.createElement('option');
                    option.textContent = `${voice.name}`;
                    option.setAttribute('data-name', voice.name);
                    this.els.voiceSelect.appendChild(option);
                });
                this.els.voiceSelect.disabled = false; this.els.speechToggle.disabled = false;
            } else {
                const option = document.createElement('option');
                option.textContent = 'æ—¥æœ¬èªéŸ³å£°ãªã—';
                this.els.voiceSelect.appendChild(option);
                this.els.voiceSelect.disabled = true; this.els.speechToggle.disabled = true;
            }
        }

        bindEvents() {
            this.els.playPauseBtn.addEventListener('click', () => this.togglePlay());
            this.els.resetBtn.addEventListener('click', () => this.reset());
            this.els.textSelect.addEventListener('change', (e) => this.loadTextContent(e.target.value));
            this.els.fontSizeSlider.addEventListener('input', () => this.updateSettings());
            this.els.speedSlider.addEventListener('input', () => this.updateSettings());
            this.els.maskRateSlider.addEventListener('input', () => this.updateSettings(true));
            window.addEventListener('resize', () => this.handleResize());
            document.addEventListener('keydown', (e) => this.handleKeydown(e));
            
            this.els.textContainer.addEventListener('mousedown', (e) => this.onDragStart(e));
            this.els.textContainer.addEventListener('touchstart', (e) => this.onDragStart(e), { passive: false });
            window.addEventListener('mousemove', (e) => this.onDragMove(e));
            window.addEventListener('touchmove', (e) => this.onDragMove(e), { passive: false });
            window.addEventListener('mouseup', (e) => this.onDragEnd(e));
            window.addEventListener('touchend', (e) => this.onDragEnd(e));

            // ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚¤ãƒ™ãƒ³ãƒˆ
            this.els.editTextBtn.addEventListener('click', () => this.openEditor());
            this.els.saveTextBtn.addEventListener('click', () => this.saveEditedText());
            this.els.cancelEditBtn.addEventListener('click', () => this.closeEditor());
        }

        openEditor() {
            this.pause();
            this.els.textEditor.value = this.state.originalText;
            this.els.editorModal.style.display = 'flex';
        }

        closeEditor() {
            this.els.editorModal.style.display = 'none';
        }

        saveEditedText() {
            this.state.originalText = this.els.textEditor.value;
            this.renderText();
            this.closeEditor();
            // ç·¨é›†ã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆã¯GitHubã®ãƒ•ã‚¡ã‚¤ãƒ«ã§ã¯ãªã„ã®ã§ã€é¸æŠçŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
            this.els.textSelect.value = '';
        }

        onDragStart(e) { /* ... å¤‰æ›´ãªã— ... */ }
        onDragMove(e) { /* ... å¤‰æ›´ãªã— ... */ }
        onDragEnd(e) { /* ... å¤‰æ›´ãªã— ... */ }
        
        updateSettings(shouldRerender = false) { /* ... å¤‰æ›´ãªã— ... */ }
        updateUIFromState() { /* ... å¤‰æ›´ãªã— ... */ }

        renderText() {
            this.pause();
            this.els.textContent.innerHTML = '';
            this.state.words = [];
            if (!this.state.originalText || this.state.originalText.trim() === '') {
                this.els.textContent.innerHTML = `<p class="loading-message">ãƒ†ã‚­ã‚¹ãƒˆãŒç©ºã§ã™ã€‚ç·¨é›†ãƒœã‚¿ãƒ³ã‹ã‚‰å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>`;
                this.reset();
                return;
            }
            const processedText = this.state.originalText.replace(/\n/g, '<br>');
            this.els.textContent.innerHTML = processedText;
            const walker = document.createTreeWalker(this.els.textContent, NodeFilter.SHOW_TEXT, null, false);
            const textNodes = [];
            let node;
            while (node = walker.nextNode()) { textNodes.push(node); }
            textNodes.forEach(textNode => {
                const parent = textNode.parentNode;
                const text = textNode.textContent;
                const wordRegex = /\p{L}+|\p{N}+|[^\s\p{L}\p{N}]+/gu;
                const matches = [...text.matchAll(wordRegex)];
                let lastIndex = 0;
                matches.forEach(match => {
                    const wordStr = match[0];
                    const index = match.index;
                    if (index > lastIndex) { parent.insertBefore(document.createTextNode(text.substring(lastIndex, index)), textNode); }
                    const wordEl = document.createElement('span');
                    wordEl.className = 'word';
                    for (const char of wordStr) {
                        const charEl = document.createElement('span');
                        charEl.className = 'char';
                        charEl.textContent = char;
                        const ignoreRegex = /[ã€Œã€ï¼ˆï¼‰ã€ã€‘ã€ã€‚ãƒ»ï¼Œ()\/]/;
                        if (/\s/.test(char)) {
                            charEl.textContent = 'âš«';
                            charEl.classList.add('placeholder-dot');
                        } else if (ignoreRegex.test(char)) {
                        } else if (Math.random() < this.state.maskRate) {
                            charEl.classList.add('hidden');
                        }
                        wordEl.appendChild(charEl);
                    }
                    parent.insertBefore(wordEl, textNode);
                    this.state.words.push(wordEl);
                    lastIndex = index + wordStr.length;
                });
                if (lastIndex < text.length) { parent.insertBefore(document.createTextNode(text.substring(lastIndex)), textNode); }
                parent.removeChild(textNode);
            });
            this.reset();
        }

        play() {
            if (this.state.words.length === 0) return;

            // â–¼â–¼â–¼ Androidã§ã®éŸ³å£°å†ç”Ÿå®‰å®šåŒ–ã®ãŸã‚ã®ä¿®æ­£ â–¼â–¼â–¼
            if (this.els.speechToggle.checked && 'speechSynthesis' in window) {
                speechSynthesis.cancel(); // å¿µã®ãŸã‚ã‚­ãƒ¥ãƒ¼ã‚’ã‚¯ãƒªã‚¢
                // ç„¡éŸ³ã®ãƒ€ãƒŸãƒ¼ç™ºè©±ã§éŸ³å£°ã‚¨ãƒ³ã‚¸ãƒ³ã‚’èµ·å‹•
                const dummyUtterance = new SpeechSynthesisUtterance(' ');
                dummyUtterance.volume = 0;
                speechSynthesis.speak(dummyUtterance);
            }
            // â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–²

            this.state.isPlaying = true;
            this.els.playPauseBtn.textContent = 'ä¸€æ™‚åœæ­¢';
            this.tick();
        }
        
        pause() { /* ... å¤‰æ›´ãªã— ... */ }
        togglePlay() { /* ... å¤‰æ›´ãªã— ... */ }
        tick() { /* ... å¤‰æ›´ãªã— ... */ }
        highlightNextWord() { /* ... å¤‰æ›´ãªã— ... */ }
        scrollToCurrentWord() { /* ... å¤‰æ›´ãªã— ... */ }
        reset() { /* ... å¤‰æ›´ãªã— ... */ }
        updateInfo() { /* ... å¤‰æ›´ãªã— ... */ }
        revealWord(wordEl) { /* ... å¤‰æ›´ãªã— ... */ }
        revealAllWords() { /* ... å¤‰æ›´ãªã— ... */ }
        handleKeydown(e) { /* ... å¤‰æ›´ãªã— ... */ }
        handleResize() { /* ... å¤‰æ›´ãªã— ... */ }
        saveSettings() { /* ... å¤‰æ›´ãªã— ... */ }
        loadSettings() { /* ... å¤‰æ›´ãªã— ... */ }
    }

    // ã‚¯ãƒ©ã‚¹ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–ï¼ˆå¤‰æ›´ãªã—ï¼‰
    new AnkiTeleprompter();
});
    </script>
</body>
</html>
